# Large and Fast Exploiting Memory Hierarchy

## Virtual Memory

main memory(DRAM)과 관련된 메모리. 우리가 가진 데이터들과 프로그램 코드는 저장장치에 있고 실행되면 main memory에 올라오게 된다(일종의 cache가 되는 셈). 그렇기 때문에 프로그램은 main memory와 공유되고, 각각의 프로그램들은 각각의 virtual address를 가져서 그 프로그램이 가진 코드와 데이터들을 거기에 갖다놓게 된다. 각자 virtual address가 있기 때문에 프로그램들은 다른 프로그램들로부터 보호가 된다.

그러므로 CPU과 OS는 virtual address와 실제 물리 주소physical address를 translate해주는 역할을 함.

이 virtual memory는 block 단위로 움직이는데 이걸 VM에서는 page라고 부른다. (cache에서나 block이라고 부름) 만약 virtual&rarr;physical로 바꾸는 데에 미스가 발생하면 그걸 page fault라고 한다. 



### Address Translation

page를 보통 4k(kilobyte)로 놓는다. VM은 physical address 혹은 disk address에 매핑되어 있다. 여기서 disk는 특히 disk의 swap area를 일컫는다.

virtual address는 32bit고, physical address는 30bit이기 때문에 전자는 4GBytes를, 후자는 1GBytes를 쓴다. virtual에서는 page가 4K라고 했으니까 page offset은 12bit만큼 쓰고 나머지 virtaul page number가 20bit를 가져간다. physical에서는 page offset은 그대로 오고 physical page number가 18bit가 된다.  20&rarr;18 이게 translation인 거 ㅇㅇ



### Virtual Addressing with a Cache

CPU &rarr; Cache &rarr; Main Memory 간 translation을 어케 하냐...

1. CPU는 VA를, cache와 main memory는 PA를 쓴다. 그래서 CPU와 cache사이에서 translation이 일어나야 한다.
2. 멀쩡히 hit이 되면 cache에 있고, miss가 되면 main memory에 갔다가 다시 cache를 통해 CPU로 돌아간다. 

근데 이렇게 하면 하나의 VA를 access하는 동안 실제로는 두 번 access하게 된다. 왜냐하면 translation의 정보가 main memory에 있기 때문에 한번 또 가야 하기 때문... miss가 나면 총 두 번 가게 되는 셈ㅇㅇ

&rarr; 그래서 새로운 장치를 하나 들이게 되는데 그게 Buffer(TLB)다. 역할은 아주 작은 cache로, 최근 translation 했던 정보들을 갖고 있다. 그래서 translation 할 때 TLB 먼저 access하고 원하는 정보가 있다면 거기서 제공하게 되는 거임(없다면 두 번 가야하지만 그걸 한 번만 하면 되니까)



### Page Fault Penalty

page fault가 발생하면 disk에 있던 page를 main memory로 올려야 한다. 근데 이 과정이 수십 만의 cycle이 필요한 거임; 그리고 이걸 OS가 관리하기 때문에(cf. cache의 miss는 CPU가 관리) 또 손실이 크다.

그래서 이 page fault를 최대한 줄여야 하는데 그러기 위해서 우리는 VA &rarr; PA로 가는 모든 정보를 다 가지고 있는 테이블을 사용하고, 또 smart replacement algorithm을 사용한다.



### Page Table?

page table entries의 배열로서, 그 index가 virtual page number가 된다. 올... 그래서 CPU에는 page table register라는 게 있는데 얘는 실제로 PM이 가진 page table을 가리킨다.

만약 page가 메모리에 있다면 page table entries는 physical page number를 가지고 있고, 그 페이지에 대한 상태 flag들이 있다. 만약 page가 메모리에 없다면, PTE는 disk의 swap space를 가리킨다.

그래서