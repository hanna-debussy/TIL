# 메모리 구조

## 메모리?

메모리는 크게 RAM과 ROM으로 분류할 수 있는데, 여기서 말하는 모든 메모리는 RAM이다. 그럼 RAM은 뭐고 ROM은 뭔지, 들어가기 전에 간단하게 알아보자.



### RAM (Random Access Memory)

RAM은 자유롭게 읽고 쓸 수 있지만 시스템의 전원이 꺼지면 기록된 내용이 모두 사라지는 **휘발성 메모리**이다. 보통 컴퓨터의 주기억장치, 응용 프로그램 로딩, 데이터 일시 저장 등에 쓰인다. 한 마디로 우리가 책상을 쓸 때 책을 읽을 땐 책을, 컴퓨터를 쓸 땐 키보드와 마우스를 올려놓는 것과 같다. 그때그때 필요한 것들을 늘어놓았다가 할일이 끝나면 전부 정리하는 것이다.



### ROM (Read Only Memory)

ROM은 이름에서 말하는 것과 같이 오직 읽어오는 것만 가능한 **비휘발성 메모리**이다 (요즘은 기술이 발전해서 저장이 가능한 방식이 있긴 하지만 이건 예외라고 하자). RAM과 다르게 시스템의 전원이 꺼져도 기록된 내용이 지워지지 않는다. 보통 기본 입출력 시스템과 같이 변경될 가능성이 적은 시스템 소프트웨어를 기록해둔다.



## 프로그램 실행 순서

그렇다면 우리는 어떻게 RAM을 활용할까? 그를 알기 위해서는 프로그램이 어떤 방식으로 돌아가는지 봐야 한다.

![img](https://blog.kakaocdn.net/dn/4Pyg4/btqUZvRMXC2/rpo7h4ppng27nltEnQFBP0/img.png)

1. 사용자가 프로그램에게 실행을 요청하면

2. 프로그램의 정보를 읽어와 메모리에 로드한다. 

   >무슨 말이냐면 기계어로 된 실행 파일을 보조기억장치에서 RAM으로 카피해온다는 뜻이다. 

3. 그러면 프로그램이 실행되고 OS는 RAM에 공간을 할당해준다. 그 자리에 프로그램에 대한 인스턴스가 생성된다.
   이 인스턴스를 프로세스라고 부른다. 우리가 `ctrl`+`alt`+`delete`를 눌러 작업관리자를 실행시켰을 때 볼 수 있는 것들이다.

4. CPU는 이 인스턴스의 기계어 코드를 가져와 실행시킨다.



## 다시 메모리 구조

프로그램도 메모리에 로드되어야 하고, 프로그램이 실행되는 동안 사용되는 수많은 변수들을 저장할 메모리도 필요하다. 이런 다양한 쓰임을 위해 컴퓨터는 그에 맞게 다양한 메모리 공간을 제공하고 할당한다.

![Imgur](https://i.imgur.com/FdJ8Xbd.png)

메모리 공간은 보통 위의 그림처럼 그려지고, 네 가지로 나뉜다.

1. Code 영역
2. Data 영역
3. Heap 영역
4. Stack 영역



### Code 영역

텍스트라고 보면 된다. 말 그대로 실행 프로그램의 코드가 저장되는 영역. 제어문, 함수, 상수 등의 명령문들이 이 영역에 저장된다.



### Data 영역

전역변수와 정적(static)변수 등이 저장되는 영역이다. 보통 이러한 애들은 프로그램 실행과 동시에 선언되어서 프로그램이 종료될 때 메모리에서 사라진다.



### Heap 영역

프로그램 사용자가 할당하고 해제하는 메모리 영역이다. 이 공간에 메모리를 할당하는 것을 동적 할당(dynamic memory allocation)이라고도 한다. **메모리의 낮은(위) 주소에서 높은(아래) 주소로 할당된다.** 그림과 반대이니 헷갈리지 말 것. 

> cf.
>
> 정적 할당: 변수를 선언하면 자료형에 따라 메모리 크기가 정해지고, 이 변수 선언은 프로그램 작성 시에 정해지므로 프로그램이 실행될 때 늘 불변한다. 
>
> 동적 할당: 사용자가 프로그램 실행 단계에서 사용할 메모리 공간을 할당하는 것. 상황에 따라 원하는 크기만큼의 메모리가 할당되고, 이미 할당된 메모리라도 언제든 크기 조정이 가능하다.



### Stack 영역

함수를 호출할 때 지역변수, 매개변수들이 저장되는 영역이다. 메인 함수 안의 변수들이 여기 해당하니까 함수가 종료되면 그 변수들은 메모리에서 해제된다. push로 데이터를 저장하고, pop으로 데이터를 해제한다. Heap과 반대로 높은(아래) 주소에서 낮은(위) 주소로 할당된다.

흔히 경험해본 재귀 stack overflow... stack 영역에 지역변수, 매개변수들이 할당해준 메모리를 넘어설 때 발생하는 오류다.

```python
# python에서 이해하자면...

a = 10			# Data 영역에 할당
b = 20			# Data 영역에 할당

def myfunc():
    x = 1		# Stack 영역에 할당
    return x
```



C 언어로 전체적으로 보면 이렇다.

![img](https://blog.kakaocdn.net/dn/duuWma/btqU0zgyW7v/OMzKAW1G6xZeczPcDSR3J1/img.png)

상수나 함수는 Code(Text) 영역, 전역/정적 변수는 Data 영역, 동적 할당이 되는 변수는 Heap 영역에, 지역 변수는 Stack 영역에 위치한다.



***

### Heap과 Stack의 관계

사실 Heap과 Stack은 같은 공간을 공유한다. 그림에서도 저렇게 그려지는 이유다. Heap이 낮은(위) 주소부터 할당된다면 Stack은 높은(아래) 주소부터 할당되면서 쓰는 식이다. 그래서 각 영역이 상대 공간을 침범하는 상황을 각각 heap overflow, stack overflow라고 한다. 



#### Stack의 장단점

* 엑세스가 매우 빠르다.
* 변수를 할당/해제할 필요가 없다.
* 메모리가 단편화되지 않는다. 즉 메모리가 낭비되는 공간 없이 사용 가능하다. 그냥 차례대로 차곡차곡 쌓기 때문이다.
* 하지만 용량이 무척 적다.
* 크기도 먼저 설정해야 한다. = 크기를 조정할 수 없다.
* 가장 top 부분만 접근이 가능하기 때문에 불편하다.



#### Heap의 장단점

* 엑세스가 상대적으로 느리다.
* 변수를 할당/해제해줘야 한다.
* 메모리가 단편화될 수 있다.
* 제대로 반환되지 않으면 메모리에 손해를 볼 수 있다.
* 그럼에도 쓰는 이유는 용량이 크고, 
* 크기를 먼저 설정해야 하는 Stack보다 유연하다. 



#### cf. 단편화?

사용 가능한 메모리가 충분히 존재하지만 할당(사용)이 불가능한 상태다.

1. 내부 단편화
   : 프로세스가 필요한 양보다 더 큰 메모리가 할당되어서 메모리가 낭비되는 상황
2. 외부 단편화
   : 메모리가 할당/해제될 때마다 그 사이사이에 작은 메모리가 존재하게 된다. 이 메모리가 많이 존재해서 총 메모리 공간은 충분하지만 실제로 할당할 수는 없는 상황



## 면접 문제들

1. 메모리 구조의 각 영역에는 어떤 것들이 저장되는가?
2. Stack과 Heap의 차이점은?

## 참조

https://jinshine.github.io/2018/05/17/%EC%BB%B4%ED%93%A8%ED%84%B0%20%EA%B8%B0%EC%B4%88/%EB%A9%94%EB%AA%A8%EB%A6%AC%EA%B5%AC%EC%A1%B0/

https://code4human.tistory.com/129

https://st-lab.tistory.com/198

https://jeong-pro.tistory.com/91

https://jaesuk-1207.tistory.com/14